{% extends "base.html" %}
{% block content %}
<div class="slideshow-container">
  <h2>{{ department | upper }} Slideshow</h2>
  <div class="slideshow" id="slideshow">
    {% for notice in notices %}
      <div class="slide" style="display: none;">
        {% set file_url = url_for('uploaded_file', filename=notice[2]) %}
        {% if notice[3] in ['png', 'jpg', 'jpeg', 'gif', 'pdf_image'] %}
          <img src="{{ file_url }}" alt="Notice Image">
        {% elif notice[3] == 'mp4' %}
          <video src="{{ file_url }}" autoplay muted playsinline></video>
        {% elif notice[3] == 'mp3' %}
          <audio src="{{ file_url }}" autoplay controls></audio>
        {% else %}
          <a href="{{ file_url }}" target="_blank" download>View Document</a>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <button id="restartSlideshow" class="btn btn-secondary" style="margin-top: 20px;">Restart Slideshow</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let slideInterval;

  // Function to start the continuous slideshow
  function startSlideshow() {
    const slides = document.querySelectorAll('.slideshow .slide');
    let currentIndex = 0;
    // Hide all slides
    slides.forEach(slide => slide.style.display = 'none');
    if (slides.length > 0) {
      slides[currentIndex].style.display = 'block';
      slideInterval = setInterval(function() {
        slides[currentIndex].style.display = 'none';
        currentIndex = (currentIndex + 1) % slides.length;
        slides[currentIndex].style.display = 'block';
      }, 5000); // change slide every 5 seconds
    }
  }

  // Function to update slideshow content in real time
  function updateSlideshow() {
    fetch("{{ url_for('get_latest_notices', dept=department) }}")
      .then(response => response.json())
      .then(data => {
        const slideshowDiv = document.getElementById('slideshow');
        let html = "";
        data.forEach(notice => {
          const fileUrl = "{{ url_for('uploaded_file', filename='') }}" + notice.filename;
          if (['png', 'jpg', 'jpeg', 'gif', 'pdf_image'].includes(notice.filetype)) {
            html += `<div class="slide" style="display: none;"><img src="${fileUrl}" alt="Notice Image"></div>`;
          } else if (notice.filetype === 'mp4') {
            html += `<div class="slide" style="display: none;"><video src="${fileUrl}" autoplay muted playsinline></video></div>`;
          } else if (notice.filetype === 'mp3') {
            html += `<div class="slide" style="display: none;"><audio src="${fileUrl}" autoplay controls></audio></div>`;
          } else {
            html += `<div class="slide" style="display: none;"><a href="${fileUrl}" target="_blank" download>View Document</a></div>`;
          }
        });
        // Update slideshow content and restart the slideshow
        slideshowDiv.innerHTML = html;
        clearInterval(slideInterval);
        startSlideshow();
      })
      .catch(error => console.error("Error updating slideshow:", error));
  }

  // Initialize slideshow on page load
  startSlideshow();
  // Poll for updates every 10 seconds
  setInterval(updateSlideshow, 10000);

  // Restart slideshow on button click
  document.getElementById('restartSlideshow').addEventListener('click', function() {
    clearInterval(slideInterval);
    startSlideshow();
  });
});
</script>
{% endblock %}
