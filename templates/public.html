{% extends "base.html" %}
{% set hide_nav = true %}
{% block content %}
<div class="public-page" style="padding: 10px;">
  <h2 style="text-align: center;">{{ department | upper }} Notices</h2>
  <div id="notices-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
    <!-- Initial notices can be empty since we are fetching them immediately -->
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Immediately fetch and render existing notices from the server
  function fetchNotices() {
    fetch("{{ url_for('get_latest_notices', dept=department) }}")
      .then(response => response.json())
      .then(data => {
        var container = document.getElementById('notices-container');
        container.innerHTML = ""; // Clear any existing content
        data.forEach(function(notice) {
          container.appendChild(createNotice(notice));
        });
      })
      .catch(err => console.error("Error fetching notices:", err));
  }
  
  // Helper function to create a notice element
  function createNotice(notice) {
    var div = document.createElement('div');
    div.className = 'notice';
    div.id = 'notice-' + notice.id;
    div.style.cssText = "flex: 1 1 auto; max-width: 100%; box-sizing: border-box; margin: 10px;";
    var fileUrl = "/uploads/" + notice.filename;
    if (['png', 'jpg', 'jpeg', 'gif', 'pdf_image'].includes(notice.filetype)) {
      div.innerHTML = '<img src="' + fileUrl + '" alt="Notice Image" style="width: 100%; height: auto; max-height: 90vh; object-fit: contain; display: block; margin: 0 auto;">';
    } else if (notice.filetype === 'mp4') {
      div.innerHTML = '<video src="' + fileUrl + '" controls style="width: 100%; height: auto; max-height: 90vh; object-fit: contain; display: block; margin: 0 auto;"></video>';
    } else if (notice.filetype === 'mp3') {
      div.innerHTML = '<audio src="' + fileUrl + '" controls style="width: 100%; height: auto; display: block; margin: 0 auto;"></audio>';
    } else {
      div.innerHTML = '<a href="' + fileUrl + '" target="_blank" style="display: inline-block;">View Document</a>';
    }
    return div;
  }

  // Fetch notices immediately on page load
  fetchNotices();

  // Setup Socket.IO connection
  var socket = io();
  socket.emit('join', '{{ department }}');

  // Listen for new immediate notices.
  socket.on('new_notice', function(data) {
    // Avoid duplicate insertion.
    if (document.getElementById('notice-' + data.id)) return;
    var container = document.getElementById('notices-container');
    container.insertBefore(createNotice(data), container.firstChild);
  });

  // Listen for new prescheduled notices (if sent before the scheduled time).
  socket.on('new_prescheduled_notice', function(data) {
    if (document.getElementById('notice-' + data.id)) return;
    var container = document.getElementById('notices-container');
    container.insertBefore(createNotice(data), container.firstChild);
  });

  // Listen for removal of prescheduled notices (when replaced by immediate ones).
  socket.on('remove_prescheduled_notice', function(data) {
    var elem = document.getElementById('notice-' + data.id);
    if (elem) {
      elem.parentElement.removeChild(elem);
    }
  });

  // Listen for deletion events (manual deletion or expired notices).
  socket.on('delete_notice', function(data) {
    var elem = document.getElementById('notice-' + data.id);
    if (elem) {
      elem.parentElement.removeChild(elem);
    }
  });
});
</script>
{% endblock %}
